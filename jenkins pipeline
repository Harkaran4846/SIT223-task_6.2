pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                echo 'üî® Stage 1: Building the application...'
                echo 'Installing dependencies...'
                echo 'Building the React application...'
            }
        }

        stage('Unit and Integration Tests') {
            steps {
                echo 'üß™ Stage 2: Running unit and integration tests using JUnit and Selenium'
            }
        }

        stage('Code Analysis') {
            steps {
                echo 'üîç Stage 3: Analyzing code using SonarQube'
            }
        }

        stage('Security Scan') {
            steps {
                echo 'üõ°Ô∏è Stage 4: Performing security scan using OWASP ZAP'
            }
        }

        stage('Deploy to Staging') {
            steps {
                echo 'üöÄ Stage 5: Deploying application to AWS EC2 staging server'
            }
        }

        stage('Integration Tests on Staging') {
            steps {
                echo '‚úÖ Stage 6: Running integration tests on staging environment'
            }
        }

        stage('Deploy to Production') {
            steps {
                echo 'üöÄ Stage 7: Deploying application to AWS EC2 production server'
            }
        }
    }

    post {
        success {
            withCredentials([string(credentialsId: 'SMTP_PASSWORD', variable: 'SMTP_PASS')]) {
                powershell '''
                $SMTPServer = "smtp.gmail.com"
                $SMTPPort = 587
                $SMTPFrom = "harkaran687@gmail.com"
                $SMTPTo = "harkaran687@gmail.com"
                $SMTPSubject = "Jenkins Pipeline Execution: SUCCESS ‚úÖ"
                $SMTPBody = "The Jenkins pipeline has been executed successfully."
                $SMTPUsername = "harkaran687@gmail.com"
                $SMTPPassword = "${env.SMTP_PASS}"
                $SMTPEnableSSL = $true

                $SMTPClient = New-Object System.Net.Mail.SmtpClient($SMTPServer, $SMTPPort)
                $SMTPClient.EnableSsl = $SMTPEnableSSL
                $SMTPClient.Credentials = New-Object System.Net.NetworkCredential($SMTPUsername, $SMTPPassword)
                $SMTPClient.Send($SMTPFrom, $SMTPTo, $SMTPSubject, $SMTPBody)
                '''
            }
            echo "‚úÖ Success Email Sent!"
        }

        failure {
            withCredentials([string(credentialsId: 'SMTP_PASSWORD', variable: 'SMTP_PASS')]) {
                powershell '''
                $SMTPServer = "smtp.gmail.com"
                $SMTPPort = 587
                $SMTPFrom = "harkaran687@gmail.com"
                $SMTPTo = "harkaran687@gmail.com"
                $SMTPSubject = "Jenkins Pipeline Execution: FAILED ‚ùå"
                $SMTPBody = "The Jenkins pipeline has failed. Please check the logs for details."
                $SMTPUsername = "harkaran687@gmail.com"
                $SMTPPassword = "${env.SMTP_PASS}"
                $SMTPEnableSSL = $true

                $SMTPClient = New-Object System.Net.Mail.SmtpClient($SMTPServer, $SMTPPort)
                $SMTPClient.EnableSsl = $SMTPEnableSSL
                $SMTPClient.Credentials = New-Object System.Net.NetworkCredential($SMTPUsername, $SMTPPassword)
                $SMTPClient.Send($SMTPFrom, $SMTPTo, $SMTPSubject, $SMTPBody)
                '''
            }
            echo "‚ùå Failure Email Sent!"
        }
    }
}
